# MSA 환경에서의 도메인별 분리와 분산 트랜잭션 처리 전략

---

## 목차

- [개요](#개요)
- [MSA 전환 필요성](#msa-전환-필요성)
    - [1. 확장성과 유연성 문제](#1-확장성과-유연성-문제)
    - [2. 데이터 일관성과 트랜잭션 한계](#2-데이터-일관성과-트랜잭션-한계)
    - [3. 장애 격리와 안정성](#3-장애-격리와-안정성)
- [도메인 분리 전략](#도메인-분리-전략)
    - [1. 도메인 선정 기준](#1-도메인-선정-기준)
    - [2. 배포 단위와 독립 서비스](#2-배포-단위와-독립-서비스)
- [분산 트랜잭션 설계](#분산-트랜잭션-설계)
    - [1. 기존 단일 트랜잭션 처리](#1-기존-단일-트랜잭션-처리)
    - [2. 분산 트랜잭션 대응 방법](#2-분산-트랜잭션-대응-방법)
        - [2-1. 2PC 방식](#2-1-2pc-방식)
        - [2-2. 이벤트 기반 SAGA 패턴](#2-2-이벤트-기반-saga-패턴)
- [설계 고려 사항](#설계-고려-사항)
- [결론 및 향후 개선 방향](#결론-및-향후-개선-방향)

---

## 개요

단일 애플리케이션에서 모든 기능을 처리하는 기존 모놀리식 구조는 트래픽 증가, 도메인 복잡도 확대, 서버 리소스 한계 등으로 확장성과 안정성에 제약을 받습니다.  
본 문서는 **도메인별 서비스 분리(MSA 전환)** 상황에서 발생하는 트랜잭션 처리 문제와 이를 해결하기 위한 설계 전략을 제시합니다.

---

## MSA 전환 필요성

### 1. 확장성과 유연성 문제

- 모놀리식 구조: 모든 도메인이 하나의 서비스에 포함 → 특정 도메인 변경 시 전체 서비스 영향
- MSA: 도메인별 독립 서비스 → 독립 배포, 확장 가능, 유지보수 용이

### 2. 데이터 일관성과 트랜잭션 한계

- 모놀리식: 단일 DB 트랜잭션으로 쉽게 처리 가능
- MSA: 서비스 간 분산 트랜잭션 발생 → 동기적 2PC 또는 이벤트 기반 SAGA 패턴 필요

### 3. 장애 격리와 안정성

- 단일 서비스 장애가 전체 시스템 다운으로 이어지는 SPOF 문제 존재
- MSA에서는 서비스 간 장애 격리 → 특정 서비스 장애 시 전체 영향 최소화 가능

---

## 도메인 분리 전략

### 1. 도메인 선정 기준

1. 핵심 비즈니스 단위: 주문, 결제, 상품 등
2. 서비스 독립성: 배포·업데이트 시 다른 서비스에 영향 최소화
3. Bounded Context 적용: 동일 용어/개념 혼동 방지

### 2. 배포 단위와 독립 서비스

- 각 도메인은 자체 DB와 API를 가짐
- 이벤트와 메시징을 통해 서비스 간 통신
- 서비스 독립 배포로 가용성 향상

---

## 분산 트랜잭션 설계

### 1. 기존 단일 트랜잭션 처리

- 하나의 트랜잭션 내에서 DB 작업, 쿠폰 적용, 재고 차감 등 처리 가능

### 2. 분산 트랜잭션 대응 방법

#### 2-1. 2PC 방식

- 모든 서비스 준비 완료 확인 후 커밋
- 장점: 강력한 일관성
- 단점: 성능 저하, SPOF, 대기 시간 증가

#### 2-2. 이벤트 기반 SAGA 패턴

- **Orchestration 기반:** 중앙 컨트롤러가 트랜잭션 관리 → 실패 시 보상 처리
- **Choreography 기반:** 서비스 간 이벤트 플로우로 트랜잭션 처리 → 중앙 제어 필요 없음
- 장점: 서비스 독립성, 확장성 향상
- 단점: 이벤트 흐름 추적 및 보상 처리 복잡

---

## 설계 고려 사항

- **보상 트랜잭션 안정성**
    - 실패 시 데이터 일관성 유지 필요
- **이벤트 상태 추적**
    - 중복 처리 및 상태 불일치 방지
- **비동기 처리 모니터링**
    - Redis 또는 Kafka 활용하여 이벤트 순서 및 상태 관리

---

## 결론 및 향후 개선 방향

- Choreography 기반 SAGA 패턴으로 서비스 독립성 확보
- 이벤트 플로우 기반 상태 추적으로 멱등성 및 데이터 일관성 보장
- Redis 기반 이벤트 관리 → Kafka 도입 시 순서 보장, 안정성 향상 가능
- 향후 보상 트랜잭션 안정성 및 이벤트 상태 관리 개선 필요