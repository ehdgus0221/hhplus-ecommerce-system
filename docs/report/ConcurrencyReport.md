# 이커머스 애플리케이션 동시성 문제 분석 및 해결 보고서

---

## 목차

- [개요](#개요)
- [주요 동시성 이슈 및 위험 시나리오](#주요-동시성-이슈-및-위험-시나리오)
  - [1. 잔액 처리 로직의 충돌 가능성](#1-잔액-처리-로직의-충돌-가능성)
  - [2. 재고 차감 시 데이터 불일치](#2-재고-차감-시-데이터-불일치)
  - [3. 선착순 쿠폰 발급의 무효화 위험](#3-선착순-쿠폰-발급의-무효화-위험)
- [동시성 제어를 위한 기술적 접근](#동시성-제어를-위한-기술적-접근)
  - [1. 데이터베이스 기반 락 활용](#1-데이터베이스-기반-락-활용)
    - [기본 개념](#기본-개념)
    - [비관적 락](#비관적-락)
    - [낙관적 락](#낙관적-락)
  - [2. Redis 기반 분산 락](#2-redis-기반-분산-락)
    - [적용 시 유의 사항](#적용-시-유의-사항)
- [기능별 동시성 제어 전략](#기능별-동시성-제어-전략)
  - [잔액 처리](#잔액-처리)
  - [선착순 쿠폰 발급](#선착순-쿠폰-발급)
  - [재고 차감](#재고-차감)
  - [정리](#정리)
    - [동일 자원에 일관된 락 전략이 필요한 이유](#동일-자원에-일관된-락-전략이-필요한-이유)
- [기술적 고려 사항 및 한계점](#기술적-고려-사항-및-한계점)

---

## 개요

이커머스 시스템은 다수의 사용자가 실시간으로 접근하는 구조적 특성상, 동일 자원에 대한 경쟁 조건이 자주 발생한다.  
잔액 충전/차감, 선착순 쿠폰 발급, 상품 재고 차감 등은 대표적인 동시성 이슈 발생 영역이다.

적절한 제어 없이 이러한 상황이 반복되면, 데이터 불일치 및 중복 처리와 같은 문제가 발생하여 서비스 신뢰성과 비즈니스 로직의 정합성이 훼손될 수 있다.

본 보고서는 이커머스 시스템 내 주요 기능에서 발생 가능한 동시성 문제를 분석하고, 이에 대한 기술적 해결 방안을 정리한 것이다.

---

## 주요 동시성 이슈 및 위험 시나리오

### 1. 잔액 처리 로직의 충돌 가능성

- 사용자가 동일 시점에 잔액을 충전하거나 차감할 경우, **최종 잔액이 정확하지 않게 반영되는 문제**가 발생할 수 있다.
- 이는 **갱신 손실(Lost Update)** 현상으로, 고빈도 요청이 발생하는 금융/결제 시스템에서 중대한 이슈로 간주된다.

### 2. 재고 차감 시 데이터 불일치

- 인기 상품의 경우, 짧은 시간 안에 주문 요청이 집중되기 쉽다.
- 다수의 트랜잭션이 **동일 재고 수량을 기준으로 차감 로직을 수행**하면, **재고 음수 발생 또는 과잉 판매**가 발생할 수 있다.

### 3. 선착순 쿠폰 발급의 무효화 위험

- 한정 수량 쿠폰을 다수의 사용자가 동시에 요청할 경우, **중복 또는 초과 발급** 문제가 발생할 수 있다.
- 또한, **실제 요청 순서와 상관없이 실패하거나 지연되는 상황이 발생**, ‘선착순’이라는 정책이 무력화될 수 있다.

---

## 동시성 제어를 위한 기술적 접근

### 1. 데이터베이스 기반 락 활용

#### 기본 개념

- 대부분의 RDBMS는 동시성 제어를 위해 **비관적 락(Pessimistic Lock)** 과 **낙관적 락(Optimistic Lock)** 두 가지 전략을 제공한다.
- MVCC(Multi-Version Concurrency Control)는 읽기 일관성을 보장하지만, 쓰기 충돌 방지를 위한 락 전략은 애플리케이션 레벨에서 명시적으로 선택되어야 한다.

#### 비관적 락

- 충돌 가능성이 높은 환경에서, **조회 시점부터 데이터에 락을 걸어** 이후 접근을 제한하는 방식이다.
- 정합성 확보에는 유리하나, **성능 저하** 및 **데드락** 발생 가능성에 유의해야 한다.

#### 낙관적 락

- 충돌이 드물다고 가정하고, **트랜잭션 종료 시점에 충돌 여부를 검증**하는 방식이다.
- 충돌 발생 시 예외 처리 및 **재시도 로직**을 통해 데이터 정합성을 보장한다.
- 고충돌 환경에서는 재시도로 인한 비용 증가를 고려해야 한다.

### 2. Redis 기반 분산 락

단일 DB 락만으로는 멀티 인스턴스 환경에서의 동시성 제어가 제한적이다.  
**Redis는 고성능 인메모리 데이터 저장소**로서, **분산 락 구현에 적합한 구조**를 제공한다.

- TTL 설정을 통해 락 소멸을 유도하고, 데드락을 예방할 수 있다.
- AOP 기반의 락 획득/해제 로직 분리를 통해 재사용성과 유지보수를 개선할 수 있다.
- Redisson, Lettuce 등 주요 라이브러리를 통한 구현이 가능하다.

#### 적용 시 유의 사항

- 락 해제는 반드시 명시적으로 수행해야 하며,
- TTL 설정이 있더라도 **소유자 검증 후 해제하는 안전한 로직**이 필요하다.

---

## 기능별 동시성 제어 전략

### 잔액 처리

- 사용자의 **중복 충전 또는 차감은 의도하지 않은 행위**로 간주된다.
- 따라서, 하나의 요청만 유효하게 처리되도록 **낙관적 락**을 적용한다.

### 선착순 쿠폰 발급

- 단순한 **낙관적 락만으로는 선착순 보장에 실패**할 수 있다.
- 여러 사용자가 동시에 요청할 경우, 일부는 충돌로 인해 반복 실패할 수 있다.
- 요청 순서 보장이 중요한 상황에서는, **비관적 락을 통한 사전 충돌 방지**가 효과적인 접근이다.

### 재고 차감

- 인기 상품 주문이 집중되는 시나리오에서는, 동시성 충돌 가능성이 매우 높다.
- 재고가 충분함에도 **차감 실패**하거나, 중복 차감으로 인해 **재고 음수 상태**가 발생할 수 있다.
- 이를 방지하기 위해, **트랜잭션 시작 시점에서 데이터에 락을 적용하는 비관적 락**을 사용한다.

### 정리

| 기능             | 충돌 가능성 | 권장 제어 방식 | 적용 범위      |
|------------------|-------------|----------------|----------------|
| 잔액 처리         | 중간         | 낙관적 락       | 사용자 단위     |
| 선착순 쿠폰 발급   | 매우 높음     | 비관적 락       | 쿠폰 ID 단위    |
| 재고 차감         | 높음         | 비관적 락       | 상품 단위       |

- 반드시 성공해야 하는 트랜잭션에는 **비관적 락이 유리**하며,
- 동일 자원에는 **일관된 락 전략**이 유지되어야 한다.

#### 동일 자원에 일관된 락 전략이 필요한 이유

1. **전략 불일치 시 경쟁 조건 발생 가능**

  - 낙관적 락은 충돌을 허용하고 커밋 시점에 검증한다.
  - 비관적 락은 충돌 자체를 방지한다.
  - 동일 자원에 상이한 락 전략이 혼용되면 **의도치 않은 동시성 충돌**이 발생할 수 있다.

2. **충돌 제어의 비효율성**

  - 요청 A: 낙관적 락 → 데이터를 먼저 읽고 마지막에 충돌 검증
  - 요청 B: 비관적 락 → 조회 시점부터 잠금 수행
  - 요청 A가 B보다 먼저 조회하였더라도, B가 락을 선점하면 A는 과거 데이터를 기준으로 처리하게 되며 정합성 문제가 발생할 수 있다.

3. **운영 환경에서의 예측 불가한 부작용**

  - 낙관적 락: 충돌로 인한 재시도 증가 → 시스템 부하 증가
  - 비관적 락: 트랜잭션 대기 증가 → 병목 현상  
    → 서로 다른 방식의 충돌 제어가 시스템 전반의 안정성에 부정적인 영향을 줄 수 있다.

---

## 기술적 고려 사항 및 한계점

- **데이터베이스 락의 제약**
  - 과도한 락 범위 설정 시 시스템 병목 가능성
  - 락 자체가 공정성을 보장하지 않으므로, ‘선착순’ 로직과 충돌 가능성 존재

- **분산 환경의 복잡성**
  - 단일 DB 기반 락은 멀티 인스턴스 환경에서는 완전한 제어가 어려움
  - Redis 기반 분산 락 또는 Kafka 등 메시지 큐 기반 직렬 처리 전략 병행 고려

- **멱등성(Idempotency) 확보 필요**
  - 중복 요청에 대비한 Idempotency Key 설계를 통해 동일 요청에 대해 동일한 응답을 보장해야 함
  - 특히 낙관적 락과 같이 재시도 로직이 포함된 처리 흐름에서는 필수 고려 요소

---
